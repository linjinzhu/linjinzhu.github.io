---
layout: post
title:  "静态库分析"
date:   2016-03-22 16:10:08 +0800
categories: ubuntu
---

## 目录

- [静态库文件结构](#静态库结构)
- [静态库支持的架构](#静态库支持的架构)
- [操作静态库](#操作静态库)
	- [按支持的架构拆分成若干个小静态库](#静态库按支持的架构拆分成若干个小静态库)
	- [删除某个指令集架构的静态库](#删除某个指令集架构的静态库)
	- [若干单个静态库合并成一个静态库](#若干单个静态库合并成一个university静态库)
- [解决实际问题](#解决实际问题)

## <span id="静态库结构">静态库结构</span>

静态库是一个压缩包，包含了所有编译后的可执行文件以及可执行文件的 symbols。一个静态库可能包含若干个不同架构的静态库。

这是 Apple 对静态库的解释：

- A **static library** is a library of code that can be linked into a binary that will, eventually, be dynamically linked to the system libraries and frameworks.
- A **statically linked binary** is one that does not import system libraries and frameworks dynamically, but instead makes direct system calls into the kernel.

解压缩静态库，会看到里面包含 “__.SYMDEF” 和很多 “*.o” 文件。下面是解压友盟统计arm64架构静态库的文件结构截图：

![image](/images/others/umeng_static_library.png)


`如何查看每个可执行文件的 symbols ？`还是以友盟统计为例（两种方式）：

	// 查看每个 .o 文件对应的 symbols
	$ nm -m libMobClickLibrary.a  | open -f
		libMobClickLibrary.a(UMWorkDispatch.o):
		000000000000019d (__TEXT,__text) non-external +[UMWorkDispatch sendEvent:withType:]
		000000000000005a (__TEXT,__text) non-external +[UMWorkDispatch sharedInstance]
		0000000000000047 (__TEXT,__text) non-external -[UMDispatchEvent .cxx_destruct]
		0000000000000000 (__TEXT,__text) non-external -[UMDispatchEvent eEventType]
		0000000000000022 (__TEXT,__text) non-external -[UMDispatchEvent object]
		0000000000000011 (__TEXT,__text) non-external -[UMDispatchEvent setEEventType:]
		0000000000000033 (__TEXT,__text) non-external -[UMDispatchEvent setObject:]
		000000000000015b (__TEXT,__text) non-external -[UMWorkDispatch dealloc]
		000000000000028f (__TEXT,__text) non-external -[UMWorkDispatch dispatchEvent:]
		000000000000010d (__TEXT,__text) non-external -[UMWorkDispatch init]
		00000000000002b1 (__TEXT,__text) non-external -[UMWorkDispatch workWithEvent:]
			....
		libMobClickLibrary.a(TTransportException.o):
		000000000000006f (__TEXT,__text) non-external +[UMTTransportException exceptionWithReason:]
		0000000000000000 (__TEXT,__text) non-external +[UMTTransportException exceptionWithReason:error:]
		                 (undefined) external _OBJC_CLASS_$_NSDictionary
		                 (undefined) external _OBJC_CLASS_$_UMTException
		00000000000001a0 (__DATA,__objc_data) external _OBJC_CLASS_$_UMTTransportException
		00000000000002c8 (__DATA,__objc_const) external _OBJC_EHTYPE_$_UMTTransportException
		                 (undefined) external _OBJC_METACLASS_$_NSObject
		                 (undefined) external _OBJC_METACLASS_$_UMTException
		0000000000000178 (__DATA,__objc_data) external _OBJC_METACLASS_$_UMTTransportException
		                 (undefined) external ___CFConstantStringClassReference
		                 (undefined) external __objc_empty_cache
		                 (undefined) external _objc_ehtype_vtable
		                 (undefined) external _objc_msgSend
		                 (undefined) external _objc_msgSendSuper2
		0000000000000200 (__DATA,__objc_const) non-external l_OBJC_$_CLASS_METHODS_UMTTransportException
		0000000000000280 (__DATA,__objc_const) non-external l_OBJC_CLASS_RO_$_UMTTransportException
		0000000000000238 (__DATA,__objc_const) non-external l_OBJC_METACLASS_RO_$_UMTTransportException
		
	// 查看每个 .o 文件对应的 symbols
	$ otool -Sv libMobClickLibrary.a | open -f	
		Archive : libMobClickLibrary.a
		Table of contents from: libMobClickLibrary.a(__.SYMDEF)
		size of ranlib structures: 4584 (number 573)
		size of strings: 21032
		object           symbol name
		UMWorkDispatch.o _OBJC_IVAR_$_UMDispatchEvent._object
		UMWorkDispatch.o _OBJC_CLASS_$_UMWorkDispatch
		UMWorkDispatch.o _OBJC_IVAR_$_UMWorkDispatch._workQueue
		....
		TException.o     _OBJC_EHTYPE_$_UMTException
		TMemoryBuffer.o  l_OBJC_LABEL_PROTOCOL_$_NSObject
		TMemoryBuffer.o  _OBJC_CLASS_$_UMTMemoryBuffer
		TMemoryBuffer.o  l_OBJC_PROTOCOL_$_NSObject
		TMemoryBuffer.o  _OBJC_METACLASS_$_UMTMemoryBuffer
		TMemoryBuffer.o  _OBJC_IVAR_$_UMTMemoryBuffer.mOffset
		TMemoryBuffer.o  _OBJC_IVAR_$_UMTMemoryBuffer.mBuffer
		TMemoryBuffer.o  l_OBJC_LABEL_PROTOCOL_$_UMTTransport
		TMemoryBuffer.o  l_OBJC_PROTOCOL_$_UMTTransport
		TTransportException.o _OBJC_CLASS_$_UMTTransportException
		TTransportException.o _OBJC_METACLASS_$_UMTTransportException
		TTransportException.o _OBJC_EHTYPE_$_UMTTransportException

## <span id="静态库支持的架构">静态库支持的架构</span>

	// 查看静态文件支持的架构
	$ lipo libMobClickLibrary.a -info
		Architectures in the fat file: libMobClickLibrary.a are: i386 armv7 armv7s x86_64 arm64

## <span id="操作静态库">操作静态库</span>

<span id="静态库按支持的架构拆分成若干个小静态库">**静态库按支持的架构拆分成若干个小静态库**</span>

	// 剥离 armv7 架构静态库
	$ lipo libMobClickLibrary.a -thin armv7 -output libMobClickLibrary.armv7
	// 剥离 arm64 架构静态库
	$ lipo libMobClickLibrary.a -thin arm64 -output libMobClickLibrary.arm64
	// 剥离 i386 架构静态库
	$ lipo libMobClickLibrary.a -thin i386 -output libMobClickLibrary.i386

<span id="删除某个指令集架构的静态库">**删除某个指令集架构的静态库**</span>

	// 删除 i386 指令集架构的静态库
	$ libMobClickLibrary.a -remove i386 -output libMobClickLibrary_new.a

<span id="若干单个静态库合并成一个university静态库">**若干单个静态库合并成一个 university 静态库**</span>

	// arm64 和 armv7 架构的静态库合并成一个库
	$ lipo libComInternational.armv7 libComInternational.arm64 -create -output libComInternational.a
	
## <span id="解决实际问题">解决实际问题</span>

- 见[《How to fix a "Duplicated Symbols" error on binary files》](http://angelolloqui.com/blog/31-How-to-fix-a-Duplicated-Symbols-error-on-binary-files)
-  删除不需要的指令集架构对应的静态库，从而缩小静态库文件大小。
